#!/bin/bash

# Get the base directory of this script
BASEDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Set PYTHONPATH to BASEDIR
export PYTHONPATH="$BASEDIR:/usr/local/lib/python3.9/site-packages"

# Ensure the history and log directories exist in BASEDIR
AI_LOG="$BASEDIR/log"
mkdir -p $AI_LOG

LLM_HISTORY_FILE=$AI_LOG/llm.history.log
CHAT_HISTORY_FILE=$AI_LOG/history.md 

AIDER="$BASEDIR/aider.py"
ENV="/opt/webpal/.env"

# Get agent ID from hostname or generate a unique one
# AGENT_ID=$(hostname)
if [ -z "$AGENT_ID" ]; then
  AGENT_ID="agent-$(date +%s)"
fi

# Redis configuration - can be overridden by environment variables
USE_REDIS=${USE_REDIS:-"true"}
REDIS_URL=${REDIS_URL:-"redis://localhost:6379/0"}
REDIS_PREFIX=${REDIS_PREFIX:-"aider:"}
REDIS_VERBOSE=${REDIS_VERBOSE:-"false"}

# Convert boolean strings to actual boolean flags
if [ "$USE_REDIS" = "true" ]; then
  REDIS_FLAGS="--use-redis"
else
  REDIS_FLAGS="--no-use-redis"
fi

if [ "$REDIS_VERBOSE" = "true" ]; then
  REDIS_VERBOSE_FLAG="--redis-verbose"
else
  REDIS_VERBOSE_FLAG="--no-redis-verbose"
fi

$AIDER \
  --env-file $ENV \
  --config "$BASEDIR/ai.conf" \
  --chat-history-file $CHAT_HISTORY_FILE \
  --llm-history-file $LLM_HISTORY_FILE \
  --input-history-file $CHAT_HISTORY_FILE \
  $REDIS_FLAGS \
  --redis-url="$REDIS_URL" \
  --redis-channel-prefix="$REDIS_PREFIX" \
  --agent-id="$AGENT_ID" \
  $REDIS_VERBOSE_FLAG \
  $*

